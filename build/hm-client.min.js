/*! Solr-Heatmap-Client created on 08-07-2016 */
angular.module("SolrHeatmapApp",["ui.bootstrap"]),angular.module("SolrHeatmapApp").controller("BackgroundLayerController",["MapService","$scope",function(a,b){var c=this;c.layers={},c.selectedLayer={},c.$on("mapReady",function(a,b){c.layers=b.getLayers().getArray(),c.selectedLayer={name:c.getBackgroundLayers()[0].get("name")}}),c.isBackgroundLayer=function(a){var b=!1;return a.get("backgroundLayer")&&(b=!0),b},c.setBackgroundLayer=function(a){angular.forEach(c.getBackgroundLayers(),function(b){b===a?(a.setVisible(!0),c.selectedLayer={name:a.get("name")}):b.setVisible(!1)})},c.getBackgroundLayers=function(){var b=a.getMap().getLayers().getArray();return b.filter(function(a){return!!a.get("backgroundLayer")})}}]),angular.module("SolrHeatmapApp").controller("DatePickerController",["HeatMapSourceGenerator","$scope",function(a,b){var c=b;c.initialDateOptions={minDate:new Date("2000-01-01"),maxDate:new Date("2016-12-31")},c.dateOptions={minDate:a.getSearchObj().minDate,maxDate:a.getSearchObj().maxDate,startingDay:1,showWeeks:!1},c.openStartDate=function(){c.startDate.opened=!0,c.dateOptions.minDate=c.initialDateOptions.minDate,c.dateOptions.maxDate=c.dte},c.openEndDate=function(){c.endDate.opened=!0,c.dateOptions.maxDate=c.initialDateOptions.maxDate,c.dateOptions.minDate=c.dts},c.startDate={opened:!1},c.endDate={opened:!1},c.setInitialDates=function(){c.dts=c.dateOptions.minDate,c.dte=c.dateOptions.maxDate},c.setInitialDates(),c.onChangeStartDate=function(){c.setDateRange(c.dts,c.dte),a.performSearch()},c.onChangeEndDate=function(){c.setDateRange(c.dts,c.dte),a.performSearch()},c.setDateRange=function(b,c){a.setMinDate(b),a.setMaxDate(c)}}]),angular.module("SolrHeatmapApp").controller("ExportController",["HeatMapSourceGenerator","$scope",function(a,b){b.startExport=function(){a.startCsvExport()}}]),angular.module("SolrHeatmapApp").controller("MainController",["Map","HeatMapSourceGenerator","$http","$scope","$rootScope",function(a,b,c,d,e){var f=this;solrHeatmapApp=f,c.get("./config/appConfig.json").success(function(c,d,f,g){if(!c||!c.mapConfig)throw"Could not find the mapConfig";var h=c.mapConfig,i=c.appConfig,j=c.bopwsConfig;a.init({mapConfig:h}),solrHeatmapApp.appConfig=i,solrHeatmapApp.initMapConf=h,solrHeatmapApp.bopwsConfig=j,e.$broadcast("mapReady",a.getMap()),a.getMap().on("moveend",function(a){b.performSearch()}),a.getMap().getView().on("change:resolution",function(b){var c=a.getLayersBy("name","HeatMapLayer");if(c&&c.length>0){var d=500*b.target.getResolution(),e=c[0];d>15&&(d=15),e.setRadius(d),e.setBlur(2*d)}a.checkBoxOfTransformInteraction()}),a.getMap().on("moveend",function(a){b.performSearch()}),a.getInteractionsByClass(ol.interaction.Transform)[0].on(["translateend","scaleend"],function(a){b.performSearch()})}).error(function(a,b,c,d){throw"Error while loading the config.json"})}]),angular.module("SolrHeatmapApp").controller("ResultCounterController",["$scope",function(a){a.$on("setCounter",function(b,c){c<1&&(c="No results found"),a.counter=c})}]),angular.module("SolrHeatmapApp").controller("SearchController",["Map","HeatMapSourceGenerator","$scope","$controller","$window",function(a,b,c,d,e){function f(a){return e.event?a.keyCode:a.which}c.searchInput="",c.onKeyPress=function(a){13===f(a)&&c.doSearch()},c.doSearch=function(){b.setSearchText(c.searchInput),b.performSearch()},c.resetSearchInput=function(){c.searchInput="",b.setSearchText(""),b.performSearch(),a.resetMap();var e=c.$new();d("DatePickerController",{$scope:e}),e.resetDates()}}]),angular.module("SolrHeatmapApp").factory("HeatMapSourceGenerator",["Map","$rootScope","$filter","$window","$document","$http",function(a,b,c,d,e,f){function g(a){v.searchText=a}function h(a){v.minDate=a}function i(a){v.maxDate=a}function j(){return v}function k(a,b,c){if(c<b){var d=b;b=c,c=d}return Math.min(Math.max(b,a),c)}function l(a){return a<-180||a>180}function m(a){return a<-90||a>90}function n(a){return k(a,-180,180)}function o(a){return k(a,-90,90)}function p(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=Math.min(d-b,360),g=Math.min(e-c,180);return l(b)?(b=n(b),d=b+f):l(d)&&(d=n(d),b=d-f),m(c)?(c=o(c),e=c+g):m(e)&&(e=o(e),c=e-g),[b,c,d,e]}function q(){var b,c,d=a.getMap(),e=d.getView().getProjection().getCode(),f=d.getView().calculateExtent(d.getSize()),g=ol.proj.transformExtent(f,e,"EPSG:4326"),h=a.getLayersBy("name","TransformInteractionLayer")[0],i={};if(!h)return null;if(b=h.getSource().getFeatures()[0],c=ol.proj.transformExtent(b.getGeometry().getExtent(),e,"EPSG:4326"),d.getView().getZoom()<=1&&(g=[-180,-90,180,90]),f&&g){var j=p(g),k=p(c),l=j[1],m=j[3],n=j[0],o=j[2];i.hmFilter={minX:l,maxX:m,minY:n,maxY:o},l=k[1],m=k[3],n=k[0],o=k[2],i.queryGeo={minX:l,maxX:m,minY:n,maxY:o}}return i}function r(){var c={},e=this.getGeospatialFilter(),g=this.getTweetsSearchQueryParameters(e.queryGeo,e.hmFilter);g["a.hm.limit"]=solrHeatmapApp.bopwsConfig.heatmapFacetLimit,g&&null!==e?(c={url:solrHeatmapApp.appConfig.tweetsSearchBaseUrl,method:"GET",params:g},f(c).success(function(c,d,e,f){c&&c["a.hm"]&&(a.createOrUpdateHeatMapLayer(c["a.hm"]),b.$broadcast("setCounter",c["a.matchDocs"]))}).error(function(a,b,c,e){d.alert("An error occured while reading heatmap data")})):d.alert("Spatial filter could not be computed.")}function s(){var a={},b=this.getGeospatialFilter(),c=this.getTweetsSearchQueryParameters(b.queryGeo,b.hmFilter);c["d.docs.limit"]=solrHeatmapApp.bopwsConfig.csvDocsLimit,c&&null!==b?(a={url:solrHeatmapApp.appConfig.tweetsExportBaseUrl,method:"GET",params:c},f(a).success(function(a,b,c,d){var f=angular.element("<a/>");f.css({display:"none"}),angular.element(e.body).append(f),f.attr({href:"data:attachment/csv;charset=utf-8,"+encodeURI(a),target:"_blank",download:"bop_export.csv"})[0].click(),f.remove()}).error(function(a,b,c,e){d.alert("An error occured while exporting csv data")})):d.alert("Spatial filter could not be computed.")}function t(a){var b,c=this.getSearchObj();b=0===c.searchText.length?"*":c.searchText;var d=a.maxX-a.minX,e=a.maxY-a.minY,f=a.minX+(1-solrHeatmapApp.appConfig.ratioInnerBbox)*d,g=a.minX+solrHeatmapApp.appConfig.ratioInnerBbox*d,h=a.minY+(1-solrHeatmapApp.appConfig.ratioInnerBbox)*e,i=a.minY+solrHeatmapApp.appConfig.ratioInnerBbox*e,j={"q.text":b,"q.time":"["+this.getFormattedDateString(c.minDate)+" TO "+this.getFormattedDateString(c.maxDate)+"]","q.geo":"["+a.minX+","+a.minY+" TO "+a.maxX+","+a.maxY+"]","a.hm.filter":"["+f+","+h+" TO "+g+","+i+"]"};return j}function u(a){return a.getFullYear()+"-"+("0"+(a.getMonth()+1)).slice(-2)+"-"+("0"+a.getDate()).slice(-2)}var v={minDate:new Date("2000-01-01"),maxDate:new Date("2016-12-31"),searchText:""},w={getGeospatialFilter:q,getTweetsSearchQueryParameters:t,performSearch:r,startCsvExport:s,setSearchText:g,setMinDate:h,setMaxDate:i,getFormattedDateString:u,getSearchObj:j};return w}]),angular.module("SolrHeatmapApp").factory("Map",["$rootScope","$filter","$document",function(a,b,c){function d(a){var b,c=[];return angular.isArray(a)&&angular.forEach(a,function(a){"TileWMS"===a.type&&(b=new ol.layer.Tile({name:a.name,backgroundLayer:a.backgroundLayer,displayInLayerPanel:a.displayInLayerPanel,source:new ol.source.TileWMS({attributions:[new ol.Attribution({html:a.attribution})],crossOrigin:a.crossOrigin,logo:a.logo,params:a.params,ratio:a.ratio,resolutions:a.resoltions,url:a.url}),opacity:a.opacity,visible:a.visible})),"ImageWMS"===a.type&&(b=new ol.layer.Image({name:a.name,backgroundLayer:a.backgroundLayer,displayInLayerPanel:a.displayInLayerPanel,source:new ol.source.ImageWMS({attributions:[new ol.Attribution({html:a.attribution})],crossOrigin:a.crossOrigin,logo:a.logo,params:a.params,resolutions:a.resoltions,url:a.url}),opacity:a.opacity,visible:a.visible})),c.push(b)}),c}function e(){return t}function f(a,c){var d=e().getLayers().getArray();return b("filter")(d,function(b){return b.get(a)===c})}function g(a){var c=e().getInteractions().getArray();return b("filter")(c,function(b){return b instanceof a})}function h(a,c){return b("filter")(a,function(a){return a.type_===c})}function i(b){var d=b.coordinate,e=t.forEachFeatureAtPixel(b.pixel,function(a,b){return a}),f="",g=c[0].getElementById("popup"),h=c[0].getElementById("popup-content"),i=c[0].getElementById("popup-closer"),j=new ol.Overlay({element:g,autoPan:!0,autoPanAnimation:{duration:250}});if(i.onclick=function(){return j.setPosition(void 0),i.blur(),!1},t.getOverlays().clear(),t.addOverlay(j),e){var k=e.get("origVal");k&&a.$broadcast("featureInfoLoaded",k)}v.$on("featureInfoLoaded",function(a,b){f+="<h5>Number of elements: </h5>"+k,h.innerHTML=f;var c=solrHeatmapApp.map.getOverlays().getArray()[0];c&&c.setPosition(d)})}function j(a){var b=f("name","HeatMapLayer")[0],c=b.getFilters()[0],d=f("backgroundLayer",!0)[0],e=d.getFilters()[0];e.setActive(!a),c.setActive(a)}function k(a,b,c){for(var d=-1,e=Number.MAX_VALUE,f=0;f<b;f++){var g=a[f];null===g&&(a[f]=g=[]);for(var h=0;h<c;h++)null===g[h]&&(g[h]=-1),g[h]>d&&(d=g[h]),g[h]<e&&g[h]>-1&&(e=g[h])}return[e,d]}function l(a,b){return null===a?0:a===-1?-1:0===a?0:b[1]-b[0]===0?0:(a-b[0])/(b[1]-b[0])}function m(a){var b,c,d=a.counts_ints2D,e=(a.gridLevel,a.columns),f=a.rows,g=a.minX,h=a.minY,i=a.maxX,j=a.maxY,m=a.projection,n=i-g,o=j-h,p=n/e,q=o/f,r=[];if(!d)return null;b=k(d,f,e);for(var s=0;s<f;s++)for(var u=0;u<e;u++){var v,w,x,y,z=d[d.length-s-1][u];if(z&&null!==z){w=h+s*q+.5*q,v=g+u*p+.5*p,y=ol.proj.transform([v,w],m,t.getView().getProjection().getCode()),x=new ol.Feature({geometry:new ol.geom.Point(y)});var A=l(z,b);x.set("weight",A),x.set("origVal",z),r.push(x)}}return c=new ol.source.Vector({features:r,useSpatialIndex:!0})}function n(a){var b,c=m(a),d=f("name","HeatMapLayer"),e=f("name","TransformInteractionLayer")[0];if(d&&d.length>0){var g=d[0],h=g.getSource();h&&h.clear(),g.setSource(c)}else{b=new ol.layer.Heatmap({name:"HeatMapLayer",source:c,radius:10}),t.addLayer(b);var i=e.getSource().getFeatures()[0],k=new ol.filter.Mask({feature:i,inner:!1,fill:new ol.style.Fill({color:[255,255,255,.5]})});b.addFilter(k)}j(null!==c)}function o(a){var b,c=f("name","TransformInteractionLayer")[0],d=c.getSource(),e=d.getFeatures()[0];b=ol.geom.Polygon.fromExtent(a),e.setGeometry(b),t.getInteractions().getArray().forEach(function(a){a instanceof ol.interaction.Transform&&a.dispatchEvent("propertychange")})}function p(a,b){var c=new ol.Feature(ol.geom.Polygon.fromExtent(a)),d=f("backgroundLayer",!0)[0];f("name","HeatMapLayer")[0];if(b!==t.getView().getProjection().getCode()){var e=ol.proj.transformExtent(a,b,t.getView().getProjection().getCode());c=new ol.Feature(ol.geom.Polygon.fromExtent(e))}var g=new ol.layer.Vector({name:"TransformInteractionLayer",source:new ol.source.Vector,style:new ol.style.Style({fill:new ol.style.Fill({color:[255,255,255,.01]})})});t.addLayer(g),g.getSource().addFeature(c);var h=new ol.interaction.Transform({translate:!0,scale:!0,translateFeature:!1,rotate:!1,stretch:!1});t.addInteraction(h);var i=new ol.filter.Mask({feature:c,inner:!1,fill:new ol.style.Fill({color:[255,255,255,.5]})});d.addFilter(i)}function q(){for(var a=f("name","TransformInteractionLayer")[0],b=t.getView().calculateExtent(t.getSize()),c=a.getSource(),d=c.getFeatures()[0],e=!1,g=d.getGeometry().getCoordinates()[0],h=0;h<g.length;h++)if(!new ol.geom.Point(g[h]).intersectsExtent(b)){e=!0;break}if(e===!0){var i=b[0],j=b[1],k=b[2],l=b[3],m=k-i,n=l-j,p=i+(1-solrHeatmapApp.appConfig.ratioInnerBbox)*m,q=i+solrHeatmapApp.appConfig.ratioInnerBbox*m,r=j+(1-solrHeatmapApp.appConfig.ratioInnerBbox)*n,s=j+solrHeatmapApp.appConfig.ratioInnerBbox*n;o([p,r,q,s])}}function r(){var a=solrHeatmapApp.initMapConf.view.center,b=solrHeatmapApp.initMapConf.view.zoom;if(b&&a){var c=t.getView();c.setCenter(a),c.setZoom(b),o(solrHeatmapApp.initMapConf.view.extent)}}function s(a){var b=angular.extend(u.view,a.mapConfig.view),c=angular.extend(u.renderer,a.mapConfig.renderer),e=a.mapConfig.layers;if(t=new ol.Map({controls:ol.control.defaults().extend([new ol.control.ScaleLine,new ol.control.ZoomSlider]),interactions:ol.interaction.defaults(),layers:d(e),renderer:angular.isString(c)?c:void 0,target:"map",view:new ol.View({center:angular.isArray(b.center)?b.center:void 0,maxZoom:angular.isNumber(b.maxZoom)?b.maxZoom:void 0,minZoom:angular.isNumber(b.minZoom)?b.minZoom:void 0,projection:angular.isString(b.projection)?b.projection:void 0,resolution:angular.isString(b.resolution)?b.resolution:void 0,resolutions:angular.isArray(b.resolutions)?b.resolutions:void 0,rotation:angular.isNumber(b.rotation)?b.rotation:void 0,zoom:angular.isNumber(b.zoom)?b.zoom:void 0,zoomFactor:angular.isNumber(b.zoomFactor)?b.zoomFactor:void 0})}),angular.isArray(b.extent)){var f=t.getView();f.set("extent",b.extent),p(b.extent,b.projection)}}var t={},u={renderer:"canvas",view:{center:[0,0],projection:"EPSG:3857",zoom:2}},v=a,w={init:s,getMap:e,getLayersBy:f,getInteractionsByClass:g,getInteractionsByType:h,displayFeatureInfo:i,createOrUpdateHeatMapLayer:n,generateMaskAndAssociatedInteraction:p,checkBoxOfTransformInteraction:q,setTransactionBBox:o,createHeatMapSource:m,heatmapMinMax:k,rescaleHeatmapValue:l,resetMap:r};return w}]);